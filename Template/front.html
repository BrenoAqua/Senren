<div style="display: none;">
_senren_presets.json
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- FRONT -->
<div class="front">

  <!-- HEADER -->
  <div class="header">

    <!-- Custom Dark Mode Toggle -->
    <span class="toggle-custom-dark-mode tappable">
      <i class="fas fa-sun sun-icon"></i>
      <i class="fas fa-moon moon-icon"></i>
    </span>
    
    {{#audioCard}}
    <span class="audio-hint toggle-trigger tappable" onclick="toggleVisibility('sentence-wrapper-audio', 'sentence-audio')">
        <i class="fas fa-lightbulb"></i>
    </span>
    {{/audioCard}}

    <script>
      function darkMode() {
        const button = document.querySelector(".toggle-custom-dark-mode");
        const body = document.querySelector("html");
        const sunIcon = document.querySelector(".sun-icon");
        const moonIcon = document.querySelector(".moon-icon");

        const applyDarkMode = () => {
          const isDarkMode = localStorage.getItem("darkMode") === "enabled";
          body.classList.toggle("custom-dark-mode", isDarkMode);
          button.classList.toggle("dark-mode", isDarkMode);

          sunIcon.style.display = isDarkMode ? "inline" : "none";
          moonIcon.style.display = isDarkMode ? "none" : "inline";
        };

        requestAnimationFrame(applyDarkMode);

        button.addEventListener("click", () => {
          const isCurrentlyDark = body.classList.contains("custom-dark-mode");
          localStorage.setItem("darkMode", isCurrentlyDark ? "disabled" : "enabled");
          requestAnimationFrame(applyDarkMode);
        });
      }
      darkMode();
    </script>
  </div>
  <!-- /HEADER -->

  <!-- Audio Card -->
  {{#audioCard}}{{#wordAudio}}
  <div id="wordAudio">
    {{wordAudio}}
  </div>
  {{/wordAudio}}{{#sentenceAudio}}

  <div id="sentenceAudio">
    {{sentenceAudio}}
  </div>
  {{/sentenceAudio}}{{/audioCard}}

  <div id="sentence-wrapper-audio">
    <div id="sentence-audio">
      {{sentence}}
    </div>
  </div>

  <!-- Sentence Card -->
  {{^audioCard}}{{#sentenceCard}}
  <div id="word-wrapper">
    <div id="word">
      {{word}}
    </div>
  </div>

  <div id="sentence" class="toggle-trigger tappable" onclick="toggleVisibility('word-wrapper', 'word')">
    {{sentence}}
  </div>
  {{/sentenceCard}}{{^sentenceCard}}

  <!-- Word Card (Default) -->
  <div class="desktop-word-layout">
    <div id="word" class="toggle-trigger tappable" onclick="toggleVisibility('sentence-wrapper', 'sentence')">
      {{word}}
    </div>
  </div>

  <div class="mobile-word-layout">
    <div class="background-box">
      <div id="word" class="toggle-trigger tappable" onclick="toggleVisibility('sentence-wrapper', 'sentence')">
        {{word}}
      </div>
    </div>
  </div>

  <div id="sentence-wrapper">
    <div id="sentence" class="sentence-front">
      {{sentence}}
    </div>
  </div>
  {{/sentenceCard}}{{/audioCard}}
</div>
<!-- /FRONT -->

<!-- Hidden field to let JS calculate audio delay based on reading length -->
<div id="hiddenReading" style="display: none !important;">{{reading}}</div>

<script>
  if (window.senrenFrontSettingsHandler) {
    document.removeEventListener('keydown', window.senrenFrontSettingsHandler);
    window.senrenFrontSettingsHandler = null;
  }
  if (window.senrenBackKeyHandler) {
    document.removeEventListener('keydown', window.senrenBackKeyHandler);
    window.senrenBackKeyHandler = null;
  }

  // Helper functions for shortcuts
  function parseKeyConfig(configStr) {
    if (!configStr) return null;
    const parts = configStr.toLowerCase().split(/[\s+]+/).filter(p => p);
    if (parts.length === 0) return null;

    const key = parts.pop();
    return {
      key: key,
      ctrl: parts.includes('ctrl') || parts.includes('control'),
      alt: parts.includes('alt'),
      shift: parts.includes('shift'),
      meta: parts.includes('meta') || parts.includes('cmd')
    };
  }

  function isKeyMatch(event, config) {
    if (!config) return false;
    return (
      event.key.toLowerCase() === config.key &&
      event.ctrlKey === config.ctrl &&
      event.altKey === config.alt &&
      event.shiftKey === config.shift &&
      event.metaKey === config.meta
    );
  }

  // Toggles visibility of word/sentence
  function toggleVisibility(wrapperId, innerElementId) {
    const wrapper = document.getElementById(wrapperId);
    const innerElement = document.getElementById(innerElementId);

    if (wrapper && innerElement) {
      const isExpanded = wrapper.classList.contains('expanded');

      if (!isExpanded) {
        const scrollHeight = innerElement.scrollHeight + 'px';
        wrapper.style.maxHeight = scrollHeight;
        wrapper.classList.add('expanded');
      } else {
        wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
        requestAnimationFrame(() => {
          wrapper.classList.remove('expanded');
          wrapper.style.maxHeight = '0px';
        });
      }
    }
  }

  // Shows or hides the audio card sentence based on CSS variables
  function initializeAudioSentenceState() {
    const isAudioCard = {{#audioCard}}true{{/audioCard}}{{^audioCard}}false{{/audioCard}};
    if (!isAudioCard) {
      return;
    }

    const wrapper = document.getElementById('sentence-wrapper-audio');
    const innerElement = document.getElementById('sentence-audio');

    if (wrapper && innerElement) {
      const expandByDefault = getComputedStyle(document.documentElement)
                              .getPropertyValue('--audio-sentence-default-expanded').trim();

      if (expandByDefault === 'true') {
        const originalWrapperTransition = wrapper.style.transition;
        const originalInnerElementTransition = innerElement.style.transition;

        wrapper.style.transition = 'none';
        innerElement.style.transition = 'none';

        requestAnimationFrame(() => {
            const scrollHeight = innerElement.scrollHeight + 'px';
            wrapper.style.maxHeight = scrollHeight;
            wrapper.classList.add('expanded');

            requestAnimationFrame(() => {
                wrapper.style.transition = originalWrapperTransition;
                innerElement.style.transition = originalInnerElementTransition;
            });
        });
      }
    }
  }

  // Shows or hides the word card sentence based on CSS variables
  function initializeSentenceState() {
    const wrapper = document.getElementById('sentence-wrapper');
    const innerElement = document.getElementById('sentence');

    if (wrapper && innerElement) {
      const expandByDefault = getComputedStyle(document.documentElement)
                              .getPropertyValue('--word-sentence-default-expanded').trim();

      if (expandByDefault === 'true') {
        const originalWrapperTransition = wrapper.style.transition;
        const originalInnerElementTransition = innerElement.style.transition;

        wrapper.style.transition = 'none';
        innerElement.style.transition = 'none';

        requestAnimationFrame(() => {
            const scrollHeight = innerElement.scrollHeight + 'px';
            wrapper.style.maxHeight = scrollHeight;
            wrapper.classList.add('expanded');

            requestAnimationFrame(() => {
                wrapper.style.transition = originalWrapperTransition;
                innerElement.style.transition = originalInnerElementTransition;
            });
        });
      }
    }
  }

  // Groups text and audio into navigable scenes
  function enableFrontSceneSwitching() {
    let initialPlayTimeout;
    let replayTimeout;

    const textContainers = document.querySelectorAll('#sentence, #sentence-audio');
    
    const audioWrapper = document.getElementById('sentenceAudio'); 
    let audioParts = [];
    if (audioWrapper) {
        audioParts = Array.from(audioWrapper.children).filter(el => {
            return el.classList.contains('soundLink') || 
                  el.classList.contains('replay-button') || 
                  el.tagName === 'AUDIO';
        });
    }

    let hasSplitText = false;
    let textSlideCount = 0;

    textContainers.forEach(container => {
      if (container.getAttribute('data-split-done')) {
          const existingParts = container.querySelectorAll('.split-sentence-part');
          if (existingParts.length > 0) {
              hasSplitText = true;
              textSlideCount = Math.max(textSlideCount, existingParts.length);
          }
          return;
      }

      const groupWrappers = Array.from(container.querySelectorAll('.group'))
                              .filter(el => el.textContent.trim().length > 0);

      if (groupWrappers.length > 0) {
        const parts = groupWrappers.map(el => el.outerHTML);
        container.innerHTML = ''; 
        parts.forEach((partHTML, index) => {
          const div = document.createElement('div');
          div.classList.add('split-sentence-part');
          div.innerHTML = partHTML;
          div.style.display = (index === 0) ? 'block' : 'none';
          container.appendChild(div);
        });
        container.setAttribute('data-split-done', 'true');
        hasSplitText = true;
        textSlideCount = Math.max(textSlideCount, parts.length);
      }
    });

    let totalSlides = Math.max(textSlideCount, audioParts.length);
    
    if (totalSlides <= 1) {
        return; 
    }

    const frontContainer = document.querySelector('.front');
    if (frontContainer && !frontContainer.querySelector('.sentence-nav')) {
      const arrowLeft = document.createElement('div');
      arrowLeft.className = 'sentence-nav left'; 
      frontContainer.appendChild(arrowLeft);
      const arrowRight = document.createElement('div');
      arrowRight.className = 'sentence-nav right'; 
      frontContainer.appendChild(arrowRight);

      [arrowLeft, arrowRight].forEach(arrow => {
        arrow.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (initialPlayTimeout) clearTimeout(initialPlayTimeout);
          const direction = arrow.classList.contains('left') ? -1 : 1;
          changeScene(direction);
        });
      });
    }

    let currentIndex = 0;

    function changeScene(direction) {
      currentIndex += direction;
      if (currentIndex >= totalSlides) currentIndex = 0;
      else if (currentIndex < 0) currentIndex = totalSlides - 1;
      updateDisplay(true);
    }

    const baseWaitTime = 100;  
    const timePerChar = 150;  
    
    const readingEl = document.getElementById('hiddenReading');
    let charCount = 5;

    if (readingEl) {
        const targetEl = readingEl.querySelector('li') || readingEl;
        let rawText = targetEl.textContent || "";

        let cleanedText = rawText.replace(/[\s\u3099\u309A\u309B\u309C]/g, '');

        cleanedText = cleanedText.replace(/[ぁぃぅぇぉゃゅょゎァィゥェォャュョヮ]/g, '');

        let effectiveCount = cleanedText.length;

        const narrowVowelRegex = /[いきしちにひみりぎじぢびぴイキシチニヒミリギジヂビピうくすつぬふむるぐずづぶぷウクスツヌフムルグズヅブプ]/g;
        const narrowMatches = cleanedText.match(narrowVowelRegex);
        
        if (narrowMatches) {
            effectiveCount -= (narrowMatches.length * 0.3);
        }

        charCount = Math.round(effectiveCount);

        if (charCount < 1) charCount = 1;
    }

    let SENTENCE_DELAY;

    if (charCount === 2) SENTENCE_DELAY = 550; 
    else if (charCount === 3) SENTENCE_DELAY = 650;
    else if (charCount === 4) SENTENCE_DELAY = 700;
    else if (charCount === 5) SENTENCE_DELAY = 850;
    else if (charCount === 6) SENTENCE_DELAY = 1000;
    else if (charCount === 7) SENTENCE_DELAY = 1080; 
    else if (charCount === 8) SENTENCE_DELAY = 1150; 
    else SENTENCE_DELAY = baseWaitTime + (charCount * timePerChar);

    const handleFrontShortcuts = (e) => {
        if (document.activeElement && ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

        const rootStyle = getComputedStyle(document.documentElement);
        const cssVal = rootStyle.getPropertyValue('--scene-replay-shortcut-key').trim();
        const replayConfig = parseKeyConfig(cssVal) || { key: 'w', ctrl: false, alt: false, shift: false, meta: false };

        if (isKeyMatch(e, replayConfig)) {
            e.preventDefault();
            e.stopPropagation();
            if (initialPlayTimeout) clearTimeout(initialPlayTimeout);
            if (replayTimeout) clearTimeout(replayTimeout);
            
            document.querySelectorAll('audio').forEach(a => {
                try { a.pause(); a.currentTime = 0; } catch(e){}
            });

            const wordAudioContainer = document.getElementById('wordAudio');
            const wordAudioBtn = wordAudioContainer ? wordAudioContainer.querySelector('.soundLink, .replaybutton') : null;
            
            if (wordAudioBtn) {
                wordAudioBtn.click();
            }

            const replayLoadOffset = 200; 
            const delay = wordAudioBtn ? (SENTENCE_DELAY + replayLoadOffset) : 0;
            
            replayTimeout = setTimeout(() => {
                updateDisplay(true); 
            }, delay);

            return;
        }

        if (e.key === 'ArrowLeft') {
            e.preventDefault(); e.stopPropagation();
            if (initialPlayTimeout) clearTimeout(initialPlayTimeout);
            if (replayTimeout) clearTimeout(replayTimeout);
            changeScene(-1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault(); e.stopPropagation();
            if (initialPlayTimeout) clearTimeout(initialPlayTimeout);
            if (replayTimeout) clearTimeout(replayTimeout);
            changeScene(1);
        }
    };

    window.currentSceneKeyHandler = handleFrontShortcuts;
    document.addEventListener('keydown', handleFrontShortcuts);

    function updateDisplay(playAudio) {
      textContainers.forEach(container => {
        const parts = container.querySelectorAll('.split-sentence-part');
        if (parts.length > 0) {
            parts.forEach((part, i) => {
                part.style.display = (i === currentIndex) ? 'block' : 'none';
            });
            const wrapper = container.closest('.expanded'); 
            if (wrapper) wrapper.style.maxHeight = container.scrollHeight + 'px';
        }
      });

      if (audioParts.length > 0) {
          audioParts.forEach((btn, i) => {
              const shouldShow = (i === currentIndex) || (audioParts.length === 1);
              if (shouldShow) {
                  btn.style.setProperty('display', 'inline-flex', 'important');
              } else {
                  btn.style.setProperty('display', 'none', 'important');
              }
          });
      }

      if (playAudio && audioParts.length > 0) {
          let target = audioParts[currentIndex];
          if (!target && audioParts.length === 1) target = audioParts[0];

          if (target) {
              if (typeof target.click === 'function') target.click();
              else {
                const trigger = target.querySelector('.soundLink, .replaybutton');
                if (trigger) trigger.click();
              }
          }
      }
    }

    updateDisplay(false); 

    const muteNsfw = getComputedStyle(document.documentElement)
      .getPropertyValue('--mute-nsfw-audio')
      .trim()
      .toLowerCase();

    if (muteNsfw !== 'true') {
      initialPlayTimeout = setTimeout(() => {
        updateDisplay(true);
      }, SENTENCE_DELAY);
    }
  }

  // Enables custom shortcuts
  function enableCustomShortcuts() {
    window.senrenFrontSettingsHandler = (e) => {
      if (document.activeElement && ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

      const rootStyle = getComputedStyle(document.body);
      
      const settingsKey = rootStyle.getPropertyValue('--toggle-settings-key').replace(/['"]/g, '').trim();
      const settingsConfig = parseKeyConfig(settingsKey);
      
      if (isKeyMatch(e, settingsConfig)) {
         e.preventDefault();
         const modal = document.getElementById('senren-settings-modal');
         if (modal) {
             modal.classList.toggle('active');
         } else {
             const btn = document.querySelector('.toggle-settings-btn');
             if (btn) btn.click();
         }
         return; 
      }

      const dmKey = rootStyle.getPropertyValue('--toggle-custom-dark-mode-key').replace(/['"]/g, '').trim();
      const dmConfig = parseKeyConfig(dmKey);
      
      if (isKeyMatch(e, dmConfig)) {
         e.preventDefault();
         const dmBtn = document.querySelector(".toggle-custom-dark-mode");
         if (dmBtn) dmBtn.click();
      }
    };
    
    document.addEventListener('keydown', window.senrenFrontSettingsHandler);
  }

  enableFrontSceneSwitching();
  initializeAudioSentenceState();
  initializeSentenceState();
  enableCustomShortcuts();
  setTimeout(() => {
    if (window.senrenBuildMenu) {
      window.senrenBuildMenu();
    } else {
      const script = document.createElement('script');
      script.src = "_senren_settings_v4.6.2.js";
      document.body.appendChild(script);
    }
  }, 0);

  void "_senren_settings_v4.6.2.css";
  void "_senren_defaults_v4.6.2.css";
</script>	